<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Political Events{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #dc2626;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --border-color: #e5e7eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        
        .main-content {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }
        
        .form-control {
            border-radius: 12px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
        }
        
        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
        }
        
        .stats-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .event-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .footer {
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            color: white;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* Real-time notification toasts */
        .toast {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
            border-radius: 8px;
        }
        
        .toast.show {
            display: block !important;
        }
        
        .toast-header.border-danger {
            border-left: 4px solid #dc3545 !important;
        }
        
        .toast-header.border-primary {
            border-left: 4px solid #0d6efd !important;
        }
        
        /* Live attendance indicators */
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Real-time location updates */
        .location-update {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-flag-usa me-2"></i>
                Political Events
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                        {% if current_user.role == 'admin' %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin_events') }}">
                                    <i class="fas fa-calendar-alt me-1"></i>Events
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin_users') }}">
                                    <i class="fas fa-users me-1"></i>Users
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin_tickets') }}">
                                    <i class="fas fa-ticket-alt me-1"></i>Tickets
                                </a>
                            </li>
                        {% elif current_user.role == 'party' %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('party_dashboard') }}">
                                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('create_event') }}">
                                    <i class="fas fa-plus me-1"></i>Create Event
                                </a>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('user_dashboard') }}">
                                    <i class="fas fa-home me-1"></i>Events
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('tickets') }}">
                                    <i class="fas fa-ticket-alt me-1"></i>Support
                                </a>
                            </li>
                        {% endif %}
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>{{ current_user.email }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('signup') }}">
                                <i class="fas fa-user-plus me-1"></i>Sign Up
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-flag-usa me-2"></i>Political Events</h5>
                    <p class="mb-0">Connecting communities through political engagement and events.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50">Terms & Conditions</a></li>
                        <li><a href="#" class="text-white-50">Privacy Policy</a></li>
                        <li><a href="#" class="text-white-50">Contact Us</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Real-time Features Restored -->
    
    <script>
        // Real-time features restored using modern web APIs
        console.log('Real-time features enabled - using modern web technologies');
        
        // Global utility functions
        function showLoading(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span> Loading...';
            button.disabled = true;
            return originalText;
        }
        
        function hideLoading(button, originalText) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Real-time notification system using Server-Sent Events
        let notificationEventSource = null;
        
        function initializeRealTimeNotifications() {
            if ('EventSource' in window) {
                try {
                    notificationEventSource = new EventSource('/api/notifications/stream');
                    
                    notificationEventSource.onmessage = function(event) {
                        const notification = JSON.parse(event.data);
                        showRealTimeNotification(notification);
                    };
                    
                    notificationEventSource.onerror = function(error) {
                        console.log('SSE connection error, falling back to polling');
                        startNotificationPolling();
                    };
                    
                    console.log('Real-time notifications enabled via Server-Sent Events');
                } catch (error) {
                    console.log('SSE failed, using polling fallback');
                    startNotificationPolling();
                }
            } else {
                console.log('EventSource not supported, using polling');
                startNotificationPolling();
            }
        }
        
        // Fallback polling system for notifications
        let notificationPollingInterval = null;
        
        function startNotificationPolling() {
            if (notificationPollingInterval) return;
            
            notificationPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/notifications/check');
                    if (response.ok) {
                        const notifications = await response.json();
                        notifications.forEach(notification => {
                            showRealTimeNotification(notification);
                        });
                    }
                } catch (error) {
                    console.log('Polling error:', error);
                }
            }, 10000); // Check every 10 seconds
            
            console.log('Real-time notifications enabled via polling');
        }
        
        function stopNotificationPolling() {
            if (notificationPollingInterval) {
                clearInterval(notificationPollingInterval);
                notificationPollingInterval = null;
            }
        }
        
        // Show real-time notification
        function showRealTimeNotification(notification) {
            // Create notification toast
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            const urgencyClass = notification.urgent ? 'border-danger' : 'border-primary';
            const urgencyIcon = notification.urgent ? 'exclamation-triangle' : 'bell';
            
            toast.innerHTML = `
                <div class="toast-header ${urgencyClass}">
                    <i class="fas fa-${urgencyIcon} me-2 text-${notification.urgent ? 'danger' : 'primary'}"></i>
                    <strong class="me-auto">${notification.title}</strong>
                    <small>${new Date().toLocaleTimeString()}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${notification.message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 8000);
        }
        
        // Live attendance updates
        function startLiveAttendanceUpdates(eventId) {
            if (!eventId) return;
            
            setInterval(async () => {
                try {
                    const response = await fetch(`/api/event/${eventId}/live-attendance`);
                    if (response.ok) {
                        const data = await response.json();
                        updateAttendanceDisplay(data);
                    }
                } catch (error) {
                    console.log('Live attendance update error:', error);
                }
            }, 15000); // Update every 15 seconds
        }
        
        function updateAttendanceDisplay(data) {
            // Update attendance counters
            const totalElement = document.getElementById('totalAttendance');
            const presentElement = document.getElementById('presentAttendance');
            const pendingElement = document.getElementById('pendingAttendance');
            
            if (totalElement) totalElement.textContent = data.total;
            if (presentElement) presentElement.textContent = data.present;
            if (pendingElement) pendingElement.textContent = data.pending;
            
            // Update progress bar
            const progressBar = document.getElementById('attendanceProgress');
            if (progressBar && data.total > 0) {
                const percentage = (data.present / data.total * 100).toFixed(1);
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
            }
        }
        
        // Real-time location updates
        function startLocationUpdates() {
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    function(position) {
                        // Update user location in real-time
                        updateUserLocation(position.coords.latitude, position.coords.longitude);
                    },
                    function(error) {
                        console.log('Location update error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
            }
        }
        
        function updateUserLocation(lat, lng) {
            // Send location update to server
            fetch('/api/user/location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            }).catch(error => console.log('Location update failed:', error));
        }
        
        // Initialize real-time features
        document.addEventListener('DOMContentLoaded', function() {
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.card, .event-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
            
            // Start real-time notifications
            initializeRealTimeNotifications();
            
            // Start location updates if user is logged in
            if (document.body.dataset.userLoggedIn === 'true') {
                startLocationUpdates();
            }
            
            // Start live attendance updates if on event page
            const eventId = document.body.dataset.eventId;
            if (eventId) {
                startLiveAttendanceUpdates(eventId);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (notificationEventSource) {
                notificationEventSource.close();
            }
            stopNotificationPolling();
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

