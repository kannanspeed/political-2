{% extends "base.html" %}

{% block title %}Events Dashboard - Political Events{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">
                <i class="fas fa-calendar-alt me-2 text-success"></i>
                Political Events
            </h1>
            <p class="text-muted mb-0">Discover and join political events in your area</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshEvents()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <button class="btn btn-outline-success" onclick="getCurrentLocation()">
                <i class="fas fa-map-marker-alt me-2"></i>My Location
            </button>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-search me-2"></i>Search Events
                            </label>
                            <input type="text" class="form-control" id="searchEvents" 
                                   placeholder="Search by title, party, or location...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-filter me-2"></i>Filter by Date
                            </label>
                            <select class="form-select" id="dateFilter">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-map-marker-alt me-2"></i>Distance
                            </label>
                            <select class="form-select" id="distanceFilter">
                                <option value="all">Any Distance</option>
                                <option value="5">Within 5 km</option>
                                <option value="10">Within 10 km</option>
                                <option value="25">Within 25 km</option>
                                <option value="50">Within 50 km</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter me-2"></i>Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Events Grid -->
    <div class="row g-4" id="eventsContainer">
        {% if events %}
            {% for event in events %}
            <div class="col-lg-6 col-xl-4 event-item" 
                 data-title="{{ event.title|lower }}" 
                 data-party="{{ event.party_name|lower }}"
                 data-location="{{ event.location|lower }}"
                 data-date="{{ event.event_date.isoformat() }}"
                 data-lat="{{ event.latitude }}"
                 data-lng="{{ event.longitude }}">
                <div class="card event-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">{{ event.title }}</h5>
                            <div class="event-status">
                                {% if event.id in registered_event_ids %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Registered
                                    </span>
                                {% else %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-calendar me-1"></i>Open
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <p class="card-text text-muted mb-3">{{ event.description[:120] }}{% if event.description|length > 120 %}...{% endif %}</p>
                        
                        <div class="event-meta mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-flag me-1"></i>
                                        {{ event.party_name }}
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ event.event_date.strftime('%b %d, %Y') }}
                                    </small>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ event.event_date.strftime('%I:%M %p') }}
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ event.location[:20] }}{% if event.location|length > 20 %}...{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="event-actions mb-3">
                            {% if event.id in registered_event_ids %}
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('user_event_detail', event_id=event.id) }}" class="btn btn-success btn-sm flex-fill">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                    <button class="btn btn-outline-warning btn-sm" onclick="showQRScanner({{ event.id }})">
                                        <i class="fas fa-qrcode"></i>
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        You're registered for this event
                                    </small>
                                </div>
                            {% else %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm flex-fill" onclick="joinEvent({{ event.id }})">
                                        <i class="fas fa-user-plus me-1"></i>Join Event
                                    </button>
                                    <a href="{{ url_for('user_event_detail', event_id=event.id) }}" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-info-circle"></i>
                                    </a>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Click to register and get location access
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="event-distance mt-3">
                            <small class="text-muted">
                                <i class="fas fa-ruler me-1"></i>
                                <span class="distance-text">Calculating distance...</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="empty-state mb-4">
                        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Events Available</h4>
                        <p class="text-muted mb-4">Check back later for upcoming political events in your area</p>
                        <button class="btn btn-primary btn-lg" onclick="refreshEvents()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Events
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Load More Button -->
    {% if events|length >= 9 %}
    <div class="row mt-4">
        <div class="col-12 text-center">
            <button class="btn btn-outline-primary btn-lg" onclick="loadMoreEvents()">
                <i class="fas fa-plus me-2"></i>Load More Events
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Join Event Modal -->
<div class="modal fade" id="joinEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    Join Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetails">
                    <!-- Event details will be loaded here -->
                </div>
                
                <hr>
                
                <div class="location-consent">
                    <h6 class="mb-3">
                        <i class="fas fa-map-marker-alt me-2 text-success"></i>
                        Location Access Required
                    </h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Important:</strong> This event requires location access to track attendance and provide location-based services.
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="locationConsent" required>
                        <label class="form-check-label" for="locationConsent">
                            I consent to share my location for this event registration
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notificationsConsent">
                        <label class="form-check-label" for="notificationsConsent">
                            I want to receive notifications about this event
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmJoinBtn" onclick="confirmJoinEvent()" disabled>
                    <i class="fas fa-user-plus me-2"></i>Join Event
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2 text-warning"></i>
                    QR Code Scanner
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrScannerContainer">
                    <div class="qr-scanner-placeholder mb-3">
                        <i class="fas fa-qrcode fa-4x text-muted"></i>
                        <p class="text-muted mt-2">QR Scanner will be activated here</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <p class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Scan the QR code at the event entrance to mark your attendance
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="manualAttendance()">
                    <i class="fas fa-check me-2"></i>Mark Attendance Manually
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentUserLocation = null;
let selectedEventId = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    calculateDistances();
});

function initializeDashboard() {
    // Initialize search functionality
    document.getElementById('searchEvents').addEventListener('input', filterEvents);
    
    // Initialize filters
    document.getElementById('dateFilter').addEventListener('change', filterEvents);
    document.getElementById('distanceFilter').addEventListener('change', filterEvents);
    
    // Get user's current location
    getCurrentLocation();
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentUserLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                showAlert('Location updated successfully!', 'success');
                
                // Update distances
                calculateDistances();
                
                // Update user location in database
                updateUserLocation(currentUserLocation);
            },
            function(error) {
                showAlert('Unable to get your location. Please enable location access.', 'warning');
            }
        );
    } else {
        showAlert('Geolocation is not supported by this browser.', 'warning');
    }
}

function updateUserLocation(location) {
    fetch('/api/user/location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(location)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Location updated successfully');
        }
    })
    .catch(error => {
        console.error('Error updating location:', error);
    });
}

function calculateDistances() {
    if (!currentUserLocation) return;
    
    const eventItems = document.querySelectorAll('.event-item');
    
    eventItems.forEach(item => {
        const lat = parseFloat(item.dataset.lat);
        const lng = parseFloat(item.dataset.lng);
        
        if (!isNaN(lat) && !isNaN(lng)) {
            const distance = calculateDistance(
                currentUserLocation.lat,
                currentUserLocation.lng,
                lat,
                lng
            );
            
            const distanceText = item.querySelector('.distance-text');
            if (distanceText) {
                distanceText.textContent = `${distance.toFixed(1)} km away`;
            }
        }
    });
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function filterEvents() {
    const searchTerm = document.getElementById('searchEvents').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const distanceFilter = document.getElementById('distanceFilter').value;
    
    const eventItems = document.querySelectorAll('.event-item');
    
    eventItems.forEach(item => {
        let show = true;
        
        // Search filter
        const title = item.dataset.title;
        const party = item.dataset.party;
        const location = item.dataset.location;
        
        if (searchTerm && !title.includes(searchTerm) && !party.includes(searchTerm) && !location.includes(searchTerm)) {
            show = false;
        }
        
        // Date filter
        if (dateFilter !== 'all') {
            const eventDate = new Date(item.dataset.date);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            const monthFromNow = new Date(today);
            monthFromNow.setMonth(monthFromNow.getMonth() + 1);
            
            switch(dateFilter) {
                case 'today':
                    show = eventDate.toDateString() === today.toDateString();
                    break;
                case 'tomorrow':
                    show = eventDate.toDateString() === tomorrow.toDateString();
                    break;
                case 'week':
                    show = eventDate >= today && eventDate <= weekFromNow;
                    break;
                case 'month':
                    show = eventDate >= today && eventDate <= monthFromNow;
                    break;
            }
        }
        
        // Distance filter
        if (distanceFilter !== 'all' && currentUserLocation) {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                const distance = calculateDistance(
                    currentUserLocation.lat,
                    currentUserLocation.lng,
                    lat,
                    lng
                );
                
                if (distance > parseFloat(distanceFilter)) {
                    show = false;
                }
            }
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

function applyFilters() {
    filterEvents();
    showAlert('Filters applied successfully!', 'success');
}

function refreshEvents() {
    const refreshBtn = event.target;
    const originalText = showLoading(refreshBtn);
    
    // Simulate refreshing events
    setTimeout(() => {
        hideLoading(refreshBtn, originalText);
        showAlert('Events refreshed successfully!', 'success');
        
        // Recalculate distances
        calculateDistances();
    }, 1000);
}

function joinEvent(eventId) {
    selectedEventId = eventId;
    
    // Get event details
    const eventItem = document.querySelector(`[data-event-id="${eventId}"]`);
    if (!eventItem) return;
    
    // Load event details into modal
    const eventDetails = document.getElementById('eventDetails');
    eventDetails.innerHTML = `
        <h6>${eventItem.querySelector('.card-title').textContent}</h6>
        <p class="text-muted">${eventItem.querySelector('.card-text').textContent}</p>
        <div class="row">
            <div class="col-6">
                <small class="text-muted">
                    <i class="fas fa-flag me-1"></i>
                    ${eventItem.querySelector('.event-meta small').textContent}
                </small>
            </div>
            <div class="col-6">
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    ${eventItem.querySelectorAll('.event-meta small')[1].textContent}
                </small>
            </div>
        </div>
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('joinEventModal'));
    modal.show();
    
    // Enable/disable join button based on consent
    document.getElementById('locationConsent').addEventListener('change', function() {
        document.getElementById('confirmJoinBtn').disabled = !this.checked;
    });
}

function confirmJoinEvent() {
    if (!currentUserLocation) {
        showAlert('Please allow location access to join this event.', 'warning');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmJoinBtn');
    const originalText = showLoading(confirmBtn);
    
    // Create form data
    const formData = new FormData();
    formData.append('latitude', currentUserLocation.lat);
    formData.append('longitude', currentUserLocation.lng);
    
    // Submit registration
    fetch(`/user/join_event/${selectedEventId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            hideLoading(confirmBtn, originalText);
            showAlert('Successfully joined the event!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('joinEventModal'));
            modal.hide();
            
            // Refresh page to update UI
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error('Failed to join event');
        }
    })
    .catch(error => {
        hideLoading(confirmBtn, originalText);
        showAlert('Failed to join event. Please try again.', 'error');
    });
}

function showQRScanner(eventId) {
    selectedEventId = eventId;
    
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
    
    // Initialize QR scanner (you can implement actual QR scanning here)
    setTimeout(() => {
        const container = document.getElementById('qrScannerContainer');
        container.innerHTML = `
            <div class="qr-scanner-active">
                <div class="scanner-frame mb-3">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                </div>
                <p class="text-primary">Position QR code within the frame</p>
            </div>
        `;
    }, 500);
}

function manualAttendance() {
    if (!selectedEventId) return;
    
    const confirmBtn = event.target;
    const originalText = showLoading(confirmBtn);
    
    // Create form data for manual attendance
    const formData = new FormData();
    formData.append('manual_attendance', 'true');
    
    // Submit manual attendance
    fetch(`/user/scan_qr/${selectedEventId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            hideLoading(confirmBtn, originalText);
            showAlert('Attendance marked successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
            modal.hide();
        } else {
            throw new Error('Failed to mark attendance');
        }
    })
    .catch(error => {
        hideLoading(confirmBtn, originalText);
        showAlert('Failed to mark attendance. Please try again.', 'error');
    });
}

function loadMoreEvents() {
    const loadMoreBtn = event.target;
    const originalText = showLoading(loadMoreBtn);
    
    // Simulate loading more events
    setTimeout(() => {
        hideLoading(loadMoreBtn, originalText);
        showAlert('More events loaded!', 'success');
        
        // You can implement actual pagination here
        loadMoreBtn.style.display = 'none';
    }, 1500);
}

// Auto-refresh events every 5 minutes
setInterval(() => {
    // You can implement real-time updates here
}, 300000);
</script>
{% endblock %}

{% block extra_css %}
<style>
.event-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.event-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.event-status .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
}

.event-meta small {
    font-size: 0.8rem;
}

.event-actions .btn {
    transition: all 0.3s ease;
}

.event-actions .btn:hover {
    transform: translateY(-2px);
}

.empty-state {
    color: #6c757d;
}

.qr-scanner-placeholder {
    text-align: center;
    color: #6c757d;
}

.scanner-frame {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
    border: 2px solid #dee2e6;
    border-radius: 12px;
}

.scanner-corner {
    position: absolute;
    width: 20px;
    height: 20px;
    border: 3px solid var(--primary-color);
}

.scanner-corner.top-left {
    top: -3px;
    left: -3px;
    border-right: none;
    border-bottom: none;
    border-top-left-radius: 8px;
}

.scanner-corner.top-right {
    top: -3px;
    right: -3px;
    border-left: none;
    border-bottom: none;
    border-top-right-radius: 8px;
}

.scanner-corner.bottom-left {
    bottom: -3px;
    left: -3px;
    border-right: none;
    border-top: none;
    border-bottom-left-radius: 8px;
}

.scanner-corner.bottom-right {
    bottom: -3px;
    right: -3px;
    border-left: none;
    border-top: none;
    border-bottom-right-radius: 8px;
}

.location-consent .alert {
    border-radius: 12px;
    border: none;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
}

.distance-text {
    font-weight: 500;
    color: var(--primary-color);
}

.card {
    animation: fadeIn 0.6s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

