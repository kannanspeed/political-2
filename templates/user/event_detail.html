{% extends "base.html" %}

{% block title %}{{ event.title }} - Event Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">
                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                {{ event.title }}
            </h1>
            <p class="text-muted mb-0">Event Details and Registration</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Events
            </a>
            {% if not registration %}
                <button class="btn btn-primary" onclick="showJoinModal()">
                    <i class="fas fa-user-plus me-2"></i>Join Event
                </button>
            {% else %}
                <span class="badge bg-success fs-6 px-3 py-2">
                    <i class="fas fa-check me-2"></i>Registered
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Event Details -->
    <div class="row g-4">
        <!-- Main Event Information -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        Event Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="event-info-item">
                                <label class="form-label fw-semibold text-muted">Event Title</label>
                                <p class="mb-0 fs-5">{{ event.title }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="event-info-item">
                                <label class="form-label fw-semibold text-muted">Organizing Party</label>
                                <p class="mb-0 fs-5">
                                    <i class="fas fa-flag me-2 text-primary"></i>
                                    {{ event.party_name }}
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="event-info-item">
                                <label class="form-label fw-semibold text-muted">Description</label>
                                <p class="mb-0">{{ event.description }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="event-info-item">
                                <label class="form-label fw-semibold text-muted">Date & Time</label>
                                <p class="mb-0">
                                    <i class="fas fa-calendar me-2 text-success"></i>
                                    {{ event.event_date|format_date('%B %d, %Y') }}
                                </p>
                                <p class="mb-0 text-muted">
                                    <i class="fas fa-clock me-2"></i>
                                    {{ event.event_date|format_date('%I:%M %p') }}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="event-info-item">
                                <label class="form-label fw-semibold text-muted">Location</label>
                                <p class="mb-0">
                                    <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                                    {{ event.location }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Map -->
            <div class="card mt-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-map me-2 text-success"></i>
                        Event Location
                    </h5>
                </div>
                <div class="card-body">
                    <div id="eventMap" style="height: 300px; border-radius: 8px;"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Registration Status -->
            <div class="card mb-4">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-user-check me-2 text-primary"></i>
                        Registration Status
                    </h6>
                </div>
                <div class="card-body">
                    {% if registration %}
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-check-circle fa-3x text-success"></i>
                            </div>
                            <h6 class="text-success mb-2">You're Registered!</h6>
                            <p class="text-muted small mb-3">Registration confirmed on {{ registration.registered_at|format_date('%B %d, %Y') }}</p>
                            
                            {% if registration.attended %}
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="fas fa-check me-2"></i>Attendance Confirmed
                                </span>
                            {% else %}
                                <span class="badge bg-warning fs-6 px-3 py-2">
                                    <i class="fas fa-clock me-2"></i>Pending Attendance
                                </span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-user-plus fa-3x text-muted"></i>
                            </div>
                            <h6 class="text-muted mb-2">Not Registered</h6>
                            <p class="text-muted small mb-3">Join this event to participate</p>
                            <button class="btn btn-primary w-100" onclick="showJoinModal()">
                                <i class="fas fa-user-plus me-2"></i>Join Event
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Event QR Code -->
            {% if registration %}
            <div class="card mb-4">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-qrcode me-2 text-warning"></i>
                        Event QR Code
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <img src="data:image/png;base64,{{ event.qr_code }}" alt="Event QR Code" 
                             style="max-width: 150px; height: auto;">
                    </div>
                    <p class="text-muted small mb-3">Show this QR code at the event entrance</p>
                    <button class="btn btn-outline-warning btn-sm" onclick="showQRScanner({{ event.id }})">
                        <i class="fas fa-qrcode me-2"></i>Scan QR
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2 text-info"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info btn-sm" onclick="shareEvent()">
                            <i class="fas fa-share me-2"></i>Share Event
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="addToCalendar()">
                            <i class="fas fa-calendar-plus me-2"></i>Add to Calendar
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="reportIssue()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Report Issue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Join Event Modal -->
<div class="modal fade" id="joinEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    Join Event: {{ event.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="event-summary mb-4">
                    <h6 class="mb-2">Event Summary</h6>
                    <div class="row g-3">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-flag me-1"></i>
                                {{ event.party_name }}
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                {{ event.event_date|format_date('%b %d, %Y') }}
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {{ event.event_date|format_date('%I:%M %p') }}
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ event.location[:20] }}{% if event.location|length > 20 %}...{% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="location-consent">
                    <h6 class="mb-3">
                        <i class="fas fa-map-marker-alt me-2 text-success"></i>
                        Location Access Required
                    </h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Important:</strong> This event requires location access to track attendance and provide location-based services.
                    </div>
                    
                                    <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="locationConsent" required onchange="handleLocationConsent(this)">
                    <label class="form-check-label" for="locationConsent">
                        I consent to share my location for this event registration
                    </label>
                </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notificationsConsent">
                        <label class="form-check-label" for="notificationsConsent">
                            I want to receive notifications about this event
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmJoinBtn" onclick="confirmJoinEvent()" disabled>
                    <i class="fas fa-user-plus me-2"></i>Join Event
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2 text-warning"></i>
                    QR Code Scanner
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrScannerContainer">
                    <div class="qr-scanner-placeholder mb-3">
                        <i class="fas fa-qrcode fa-4x text-muted"></i>
                        <p class="text-muted mt-2">QR Scanner will be activated here</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <p class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Scan the QR code at the event entrance to mark your attendance
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="manualAttendance()">
                    <i class="fas fa-check me-2"></i>Mark Attendance Manually
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places"></script>

<script>
let currentUserLocation = null;
let selectedEventId = {{ event.id }};

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeEventMap();
    
    // Enable/disable join button based on consent
    const locationConsent = document.getElementById('locationConsent');
    if (locationConsent) {
        locationConsent.addEventListener('change', function() {
            document.getElementById('confirmJoinBtn').disabled = !this.checked;
        });
    }
});

function initializeEventMap() {
    const mapElement = document.getElementById('eventMap');
    if (!mapElement) return;
    
    // Wait for Google Maps API to load
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        setTimeout(initializeEventMap, 100);
        return;
    }
    
    // Initialize Google Maps
    const map = new google.maps.Map(mapElement, {
        zoom: 15,
        center: { lat: {{ event.latitude }}, lng: {{ event.longitude }} },
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    
    // Add event marker
    new google.maps.Marker({
        position: { lat: {{ event.latitude }}, lng: {{ event.longitude }} },
        map: map,
        title: '{{ event.title }}',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        }
    });
}

function showJoinModal() {
    const modal = new bootstrap.Modal(document.getElementById('joinEventModal'));
    modal.show();
}

function handleLocationConsent(checkbox) {
    console.log('handleLocationConsent called, checked:', checkbox.checked);
    
    if (checkbox.checked) {
        // Get user location when consent is given
        getCurrentLocation();
        // Enable join button
        document.getElementById('confirmJoinBtn').disabled = false;
        console.log('Join button enabled by consent');
    } else {
        // Disable join button if consent is withdrawn
        document.getElementById('confirmJoinBtn').disabled = true;
        currentUserLocation = null;
        console.log('Join button disabled, location cleared');
    }
}

function confirmJoinEvent() {
    console.log('confirmJoinEvent called, currentUserLocation:', currentUserLocation);
    
    if (!currentUserLocation) {
        showAlert('Please allow location access to join this event.', 'warning');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmJoinBtn');
    const originalText = showLoading(confirmBtn);
    
    // Create form data
    const formData = new FormData();
    formData.append('latitude', currentUserLocation.lat);
    formData.append('longitude', currentUserLocation.lng);
    
    console.log('Submitting registration with location:', currentUserLocation);
    
    // Submit registration
    fetch(`/user/join_event/{{ event.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (response.ok) {
            hideLoading(confirmBtn, originalText);
            showAlert('Successfully joined the event!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('joinEventModal'));
            modal.hide();
            
            // Refresh page to update UI
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error('Failed to join event');
        }
    })
    .catch(error => {
        console.error('Error joining event:', error);
        hideLoading(confirmBtn, originalText);
        showAlert('Failed to join event. Please try again.', 'error');
    });
}

function showQRScanner(eventId) {
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
    
    // Initialize QR scanner (you can implement actual QR scanning here)
    setTimeout(() => {
        const container = document.getElementById('qrScannerContainer');
        container.innerHTML = `
            <div class="qr-scanner-active">
                <div class="scanner-frame mb-3">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                </div>
                <p class="text-muted">Point camera at QR code</p>
            </div>
        `;
    }, 500);
}

function manualAttendance() {
    const confirmBtn = event.target;
    const originalText = showLoading(confirmBtn);
    
    // Create form data for manual attendance
    const formData = new FormData();
    formData.append('manual_attendance', 'true');
    
    // Submit manual attendance
    fetch(`/user/scan_qr/{{ event.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            hideLoading(confirmBtn, originalText);
            showAlert('Attendance marked successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
            modal.hide();
        } else {
            throw new Error('Failed to mark attendance');
        }
    })
    .catch(error => {
        hideLoading(confirmBtn, originalText);
        showAlert('Failed to mark attendance. Please try again.', 'error');
    });
}

function shareEvent() {
    if (navigator.share) {
        navigator.share({
            title: '{{ event.title }}',
            text: 'Check out this political event!',
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            showAlert('Event link copied to clipboard!', 'success');
        });
    }
}

function addToCalendar() {
    const eventDate = new Date('{{ event.event_date.isoformat() }}');
    const endDate = new Date(eventDate.getTime() + (2 * 60 * 60 * 1000)); // 2 hours duration
    
    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ event.title|urlencode }}&dates=${eventDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details={{ event.description|urlencode }}&location={{ event.location|urlencode }}`;
    
    window.open(calendarUrl, '_blank');
}

function reportIssue() {
    showAlert('Redirecting to support tickets...', 'info');
    setTimeout(() => {
        window.location.href = '{{ url_for("create_ticket") }}';
    }, 1500);
}

// Get current location when needed
function getCurrentLocation() {
    console.log('getCurrentLocation called');
    
    if (navigator.geolocation) {
        // Show loading state
        showAlert('Getting your location...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('Location obtained:', position.coords);
                currentUserLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                console.log('currentUserLocation set to:', currentUserLocation);
                showAlert(`Location captured! (${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)})`, 'success');
                
                // Enable join button if consent is checked
                const locationConsent = document.getElementById('locationConsent');
                if (locationConsent && locationConsent.checked) {
                    document.getElementById('confirmJoinBtn').disabled = false;
                    console.log('Join button enabled');
                }
            },
            function(error) {
                let errorMessage = 'Location access denied. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access in your browser.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'An unknown error occurred.';
                        break;
                }
                showAlert(errorMessage, 'error');
                
                // Disable join button if location can't be obtained
                document.getElementById('confirmJoinBtn').disabled = true;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        showAlert('Geolocation is not supported by this browser.', 'error');
        document.getElementById('confirmJoinBtn').disabled = true;
    }
}

// Utility functions
function showLoading(button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    button.disabled = true;
    return originalText;
}

function hideLoading(button, originalText) {
    button.innerHTML = originalText;
    button.disabled = false;
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of content
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.event-info-item {
    margin-bottom: 1rem;
}

.event-info-item label {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.event-info-item p {
    color: #212529;
}

.card {
    border: none;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
}

.card-header {
    border-bottom: 1px solid #e9ecef;
    background-color: #f8f9fa;
    border-radius: 12px 12px 0 0 !important;
}

.qr-scanner-placeholder {
    text-align: center;
    color: #6c757d;
}

.scanner-frame {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
    border: 2px solid #dee2e6;
    border-radius: 12px;
}

.scanner-corner {
    position: absolute;
    width: 20px;
    height: 20px;
    border: 3px solid var(--primary-color);
}

.scanner-corner.top-left {
    top: -3px;
    left: -3px;
    border-right: none;
    border-bottom: none;
    border-top-left-radius: 8px;
}

.scanner-corner.top-right {
    top: -3px;
    right: -3px;
    border-left: none;
    border-bottom: none;
    border-top-right-radius: 8px;
}

.scanner-corner.bottom-left {
    bottom: -3px;
    left: -3px;
    border-right: none;
    border-top: none;
    border-bottom-left-radius: 8px;
}

.scanner-corner.bottom-right {
    bottom: -3px;
    right: -3px;
    border-left: none;
    border-top: none;
    border-bottom-right-radius: 8px;
}

.location-consent .alert {
    border-radius: 12px;
    border: none;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
}

.badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

#eventMap {
    border: 1px solid #dee2e6;
}

.alert {
    border-radius: 12px;
    border: none;
    margin-bottom: 1rem;
}
</style>
{% endblock %}
