{% extends "base.html" %}

{% block title %}Create Event - Political Events{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-calendar-plus me-2 text-primary"></i>
                                Create New Event
                            </h2>
                            <p class="text-muted mb-0">Set up a political event to engage with your community</p>
                        </div>
                        <a href="{{ url_for('party_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
                
                <div class="card-body p-5">
                    <form method="POST" id="createEventForm">
                        <div class="row g-4">
                            <!-- Event Basic Information -->
                            <div class="col-12">
                                <h5 class="mb-3 text-primary">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Event Information
                                </h5>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-semibold">
                                        <i class="fas fa-heading me-2"></i>Event Title
                                    </label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           placeholder="Enter event title" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="event_date" class="form-label fw-semibold">
                                        <i class="fas fa-calendar me-2"></i>Event Date & Time
                                    </label>
                                    <input type="datetime-local" class="form-control" id="event_date" 
                                           name="event_date" required>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="description" class="form-label fw-semibold">
                                        <i class="fas fa-align-left me-2"></i>Event Description
                                    </label>
                                    <textarea class="form-control" id="description" name="description" 
                                              rows="4" placeholder="Describe your event..." required></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Provide a clear description of what attendees can expect
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location Information -->
                            <div class="col-12">
                                <h5 class="mb-3 text-success">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Location Details
                                </h5>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="location" class="form-label fw-semibold">
                                        <i class="fas fa-map me-2"></i>Event Location
                                    </label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           placeholder="Enter event address or venue name" required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Start typing to see address suggestions, or enter manually
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden coordinates fields -->
                            <input type="hidden" id="latitude" name="latitude" required>
                            <input type="hidden" id="longitude" name="longitude" required>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-map-marked-alt me-2"></i>Location Preview
                                    </label>
                                    <div id="map" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
                                    <div class="form-text mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        The map will show your selected location. You can also click on the map to adjust the location.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Event Settings -->
                            <div class="col-12">
                                <h5 class="mb-3 text-warning">
                                    <i class="fas fa-cog me-2"></i>
                                    Event Settings
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-users me-2"></i>Registration Settings
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="requireLocation" checked disabled>
                                        <label class="form-check-label" for="requireLocation">
                                            Require location access for registration
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoGenerateQR" checked disabled>
                                        <label class="form-check-label" for="autoGenerateQR">
                                            Auto-generate QR code for check-in
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-bell me-2"></i>Notification Settings
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendReminders" checked>
                                        <label class="form-check-label" for="sendReminders">
                                            Send reminder notifications
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="liveUpdates" checked>
                                        <label class="form-check-label" for="liveUpdates">
                                            Enable live attendance updates
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code Preview -->
                            <div class="col-12">
                                <h5 class="mb-3 text-info">
                                    <i class="fas fa-qrcode me-2"></i>
                                    QR Code Preview
                                </h5>
                                <div class="text-center">
                                    <div id="qrPreview" class="qr-preview-container">
                                        <div class="qr-placeholder">
                                            <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                                            <p class="text-muted">QR code will be generated after event creation</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex gap-3 justify-content-end">
                            <a href="{{ url_for('party_dashboard') }}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i class="fas fa-calendar-plus me-2"></i>Create Event
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
let map, marker, autocomplete;
let currentLocation = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    initializeAutocomplete();
    initializeForm();
    
    // Set minimum date to today
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(12, 0, 0, 0);
    
    document.getElementById('event_date').min = tomorrow.toISOString().slice(0, 16);
});

function initializeMap() {
    // Default center (you can change this to your preferred location)
    const defaultCenter = { lat: 20.5937, lng: 78.9629 }; // India center
    
    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 5,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });
    
    // Add click listener to map
    map.addListener('click', function(event) {
        placeMarker(event.latLng);
    });
    
    // Try to get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                currentLocation = pos;
                map.setCenter(pos);
                map.setZoom(13);
                placeMarker(pos);
                
                // Update form fields
                document.getElementById('latitude').value = pos.lat.toFixed(6);
                document.getElementById('longitude').value = pos.lng.toFixed(6);
                
                // Reverse geocode to get address
                reverseGeocode(pos);
            },
            function() {
                // If geolocation fails, use default center
                placeMarker(defaultCenter);
                document.getElementById('latitude').value = defaultCenter.lat.toFixed(6);
                document.getElementById('longitude').value = defaultCenter.lng.toFixed(6);
            }
        );
    } else {
        // Browser doesn't support geolocation
        placeMarker(defaultCenter);
        document.getElementById('latitude').value = defaultCenter.lat.toFixed(6);
        document.getElementById('longitude').value = defaultCenter.lng.toFixed(6);
    }
}

function initializeAutocomplete() {
    const locationInput = document.getElementById('location');
    
    // Create autocomplete object
    autocomplete = new google.maps.places.Autocomplete(locationInput, {
        types: ['establishment', 'geocode'],
        componentRestrictions: { country: 'IN' }, // Restrict to India
        fields: ['formatted_address', 'geometry', 'name']
    });
    
    // Add listener for place selection
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry) {
            // User entered the name of a Place that was not suggested and
            // pressed the Enter key, or the Place Details request failed.
            showAlert('No details available for the selected location.', 'warning');
            return;
        }
        
        // Update map and marker
        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
        }
        
        placeMarker(place.geometry.location);
        
        // Update coordinates
        document.getElementById('latitude').value = place.geometry.location.lat().toFixed(6);
        document.getElementById('longitude').value = place.geometry.location.lng().toFixed(6);
        
        // Update location field with formatted address
        if (place.formatted_address) {
            locationInput.value = place.formatted_address;
        }
        
        // Validate form
        validateForm();
    });
}

function placeMarker(latLng) {
    if (marker) {
        marker.setMap(null);
    }
    
    marker = new google.maps.Marker({
        position: latLng,
        map: map,
        title: 'Event Location',
        animation: google.maps.Animation.DROP
    });
    
    // Update form fields
    document.getElementById('latitude').value = latLng.lat().toFixed(6);
    document.getElementById('longitude').value = latLng.lng().toFixed(6);
    
    // Reverse geocode to get address
    reverseGeocode(latLng);
    
    // Center map on marker
    map.setCenter(latLng);
}

function reverseGeocode(latLng) {
    const geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ location: latLng }, function(results, status) {
        if (status === 'OK') {
            if (results[0]) {
                document.getElementById('location').value = results[0].formatted_address;
            }
        }
    });
}

function geocodeAddress(address) {
    const geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ 
        address: address,
        componentRestrictions: { country: 'IN' } // Restrict to India
    }, function(results, status) {
        if (status === 'OK') {
            if (results[0]) {
                const location = results[0].geometry.location;
                
                // Update coordinates
                document.getElementById('latitude').value = location.lat().toFixed(6);
                document.getElementById('longitude').value = location.lng().toFixed(6);
                
                // Update map
                map.setCenter(location);
                map.setZoom(15);
                placeMarker(location);
                
                // Update location field with formatted address
                document.getElementById('location').value = results[0].formatted_address;
                
                // Validate form
                validateForm();
            }
        } else {
            // If geocoding fails, clear coordinates
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            
            // Show warning
            showAlert('Could not find coordinates for this address. Please select from suggestions or click on the map.', 'warning');
        }
    });
}

function initializeForm() {
    const form = document.getElementById('createEventForm');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', function(e) {
        // Validate form
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        const originalText = showLoading(submitBtn);
        
        // Let the form submit naturally to the server
        // The server will handle the event creation and redirect
        // We'll reset the loading state after a delay in case of errors
        setTimeout(() => {
            hideLoading(submitBtn, originalText);
        }, 10000); // Reset after 10 seconds if no response
    });
    
    // Real-time validation
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const locationInput = document.getElementById('location');
    
    [titleInput, descriptionInput].forEach(input => {
        input.addEventListener('input', validateForm);
    });
    
    // Handle manual location entry
    locationInput.addEventListener('input', function() {
        validateForm();
        
        // If user types manually and there are no coordinates, try to geocode
        const location = this.value.trim();
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        if (location && (!latitude || !longitude)) {
            // Clear coordinates to force re-geocoding
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            
            // Try to geocode the entered address
            geocodeAddress(location);
        }
    });
    
    // Handle location field blur (when user finishes typing)
    locationInput.addEventListener('blur', function() {
        const location = this.value.trim();
        if (location) {
            geocodeAddress(location);
        }
    });
}

function validateForm() {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const location = document.getElementById('location').value.trim();
    const eventDate = document.getElementById('event_date').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    
    let isValid = true;
    
    // Clear previous error states
    clearErrors();
    
    if (!title) {
        showError('title', 'Event title is required');
        isValid = false;
    } else if (title.length < 5) {
        showError('title', 'Event title must be at least 5 characters');
        isValid = false;
    }
    
    if (!description) {
        showError('description', 'Event description is required');
        isValid = false;
    } else if (description.length < 20) {
        showError('description', 'Event description must be at least 20 characters');
        isValid = false;
    }
    
    if (!location) {
        showError('location', 'Event location is required');
        isValid = false;
    }
    
    if (!eventDate) {
        showError('event_date', 'Event date and time is required');
        isValid = false;
    }
    
    // Only validate coordinates if location is provided
    if (location && (!latitude || !longitude)) {
        showError('location', 'Please select a valid location from suggestions or click on the map');
        isValid = false;
    }
    
    // Update submit button state
    document.getElementById('submitBtn').disabled = !isValid;
    
    return isValid;
}

function showError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback d-block';
    errorDiv.textContent = message;
    
    field.classList.add('is-invalid');
    field.parentNode.appendChild(errorDiv);
}

function clearErrors() {
    const errorFields = document.querySelectorAll('.is-invalid');
    errorFields.forEach(field => {
        field.classList.remove('is-invalid');
        const errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
    });
}

// Show alert messages
function showAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the form
    const form = document.getElementById('createEventForm');
    form.insertBefore(alertDiv, form.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-save form data to localStorage
function autoSave() {
    const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        location: document.getElementById('location').value,
        event_date: document.getElementById('event_date').value
    };
    
    localStorage.setItem('eventFormData', JSON.stringify(formData));
}

// Load saved form data
function loadSavedData() {
    const savedData = localStorage.getItem('eventFormData');
    if (savedData) {
        const data = JSON.parse(savedData);
        
        document.getElementById('title').value = data.title || '';
        document.getElementById('description').value = data.description || '';
        document.getElementById('location').value = data.location || '';
        document.getElementById('event_date').value = data.event_date || '';
    }
}

// Auto-save every 5 seconds
setInterval(autoSave, 5000);

// Load saved data on page load
loadSavedData();
</script>
{% endblock %}

{% block extra_css %}
<style>
.qr-preview-container {
    padding: 2rem;
    border: 2px dashed #dee2e6;
    border-radius: 16px;
    background: #f8f9fa;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qr-placeholder {
    text-align: center;
    color: #6c757d;
}

.form-control:focus {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30, 64, 175, 0.15);
}

.btn:hover {
    transform: translateY(-2px);
}

.card {
    animation: slideUp 0.6s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#map {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#map:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
}
</style>
{% endblock %}

