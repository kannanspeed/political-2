{% extends "base.html" %}

{% block title %}Party Dashboard - Political Events{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">
                <i class="fas fa-flag me-2 text-primary"></i>
                {{ current_user.party_name or 'Political Party' }} Dashboard
            </h1>
            <p class="text-muted mb-0">Manage your political events and track engagement</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshStats()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <a href="{{ url_for('create_event') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Event
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Events</h6>
                            <h2 class="stats-number mb-0">{{ events|length }}</h2>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-calendar-alt fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Active Events</h6>
                            <h2 class="stats-number mb-0">{{ events|selectattr('is_active', 'equalto', true)|list|length }}</h2>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-play-circle fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Registrations</h6>
                            <h2 class="stats-number mb-0">
                                {% set total_registrations = 0 %}
                                {% for event in events %}
                                    {% set total_registrations = total_registrations + event.registrations|length %}
                                {% endfor %}
                                {{ total_registrations }}
                            </h2>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-user-check fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Upcoming Events</h6>
                            <h2 class="stats-number mb-0">
                                {% set upcoming_count = 0 %}
                                {% for event in events %}
                                    {% if event.event_date > now %}
                                        {% set upcoming_count = upcoming_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ upcoming_count }}
                            </h2>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-clock fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{{ url_for('create_event') }}" class="btn btn-outline-primary w-100 py-3">
                                <i class="fas fa-plus fa-2x d-block mb-2"></i>
                                Create Event
                            </a>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100 py-3" onclick="showAnalytics()">
                                <i class="fas fa-chart-line fa-2x d-block mb-2"></i>
                                View Analytics
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-info w-100 py-3" onclick="showNotifications()">
                                <i class="fas fa-bell fa-2x d-block mb-2"></i>
                                Send Notifications
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100 py-3" onclick="showPartySettings()">
                                <i class="fas fa-cog fa-2x d-block mb-2"></i>
                                Party Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Events Overview -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>
                        Your Events
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="eventFilter" style="width: auto;">
                            <option value="all">All Events</option>
                            <option value="active">Active</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="past">Past</option>
                        </select>
                        <a href="{{ url_for('create_event') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>New Event
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if events %}
                        <div class="row g-4" id="eventsContainer">
                            {% for event in events %}
                            <div class="col-lg-6 col-xl-4 event-item" data-status="{{ 'upcoming' if event.event_date > now else 'past' }}" data-active="{{ 'true' if event.is_active else 'false' }}">
                                <div class="card event-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h5 class="card-title mb-0">{{ event.title }}</h5>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="{{ url_for('party_event_detail', event_id=event.id) }}">
                                                        <i class="fas fa-eye me-2"></i>View Details
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{{ url_for('party_event_detail', event_id=event.id) }}">
                                                        <i class="fas fa-map-marked-alt me-2"></i>View Map & Details
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-warning" href="#" onclick="editEvent({{ event.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit Event
                                                    </a></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteEvent({{ event.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete Event
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <p class="card-text text-muted mb-3">{{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</p>
                                        
                                        <div class="event-meta mb-3">
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        {{ event.location }}
                                                    </small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ event.event_date|format_date('%b %d, %Y') }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="event-stats mb-3">
                                            <div class="row g-2 text-center">
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <h6 class="mb-0 text-primary">{{ event.registrations|length }}</h6>
                                                        <small class="text-muted">Registered</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <h6 class="mb-0 text-success">
                                                            {{ event.registrations|selectattr('attended', 'equalto', true)|list|length }}
                                                        </h6>
                                                        <small class="text-muted">Attended</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <h6 class="mb-0 text-warning">
                                                            {{ event.registrations|selectattr('attended', 'equalto', false)|list|length }}
                                                        </h6>
                                                        <small class="text-muted">Absent</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <a href="{{ url_for('party_event_detail', event_id=event.id) }}" class="btn btn-primary btn-sm flex-fill">
                                                <i class="fas fa-eye me-1"></i>View Details
                                            </a>
                                            <a href="{{ url_for('party_event_detail', event_id=event.id) }}" class="btn btn-outline-info btn-sm">
                                                <i class="fas fa-map-marked-alt me-1"></i>Map
                                            </a>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <span class="badge bg-{{ 'success' if event.is_active else 'secondary' }} me-2">
                                                {{ 'Active' if event.is_active else 'Inactive' }}
                                            </span>
                                            <span class="badge bg-{{ 'primary' if event.event_date > now else 'secondary' }}">
                                                {{ 'Upcoming' if event.event_date > now else 'Past' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="empty-state mb-4">
                                <i class="fas fa-calendar-plus fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">No Events Yet</h4>
                                <p class="text-muted mb-4">Start creating political events to engage with your community</p>
                                <a href="{{ url_for('create_event') }}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-2"></i>Create Your First Event
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2 text-success"></i>
                    Event Analytics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Registration Trends</h6>
                                <canvas id="registrationChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Attendance Rates</h6>
                                <canvas id="attendanceChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Modal -->
<div class="modal fade" id="notificationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2 text-info"></i>
                    Send Notifications
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="notificationForm">
                    <div class="mb-3">
                        <label class="form-label">Select Event</label>
                        <select class="form-select" name="event_id" required>
                            <option value="">Choose an event...</option>
                            {% for event in events %}
                            <option value="{{ event.id }}">{{ event.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Title</label>
                        <input type="text" class="form-control" name="title" placeholder="Enter notification title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="4" placeholder="Enter notification message" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="urgent" id="urgentNotification">
                            <label class="form-check-label" for="urgentNotification">
                                Mark as urgent
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendNotification()">Send Notification</button>
            </div>
        </div>
    </div>
</div>

<!-- Party Settings Modal -->
<div class="modal fade" id="partySettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2 text-warning"></i>
                    Party Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="partySettingsForm">
                    <div class="mb-3">
                        <label class="form-label">Party Name</label>
                        <input type="text" class="form-control" name="party_name" value="{{ current_user.party_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" value="{{ current_user.email }}" readonly>
                        <div class="form-text">Email cannot be changed</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="phone" value="{{ current_user.phone }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePartySettings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Invitation Modal -->
<div class="modal fade" id="bulkInvitationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane me-2 text-info"></i>
                    Bulk Invitation System
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Target Event</label>
                    <select class="form-select" id="targetEvent" required>
                        <option value="">Choose an event...</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Custom Message (optional)</label>
                    <textarea class="form-control" id="customMessage" rows="3" placeholder="Enter a custom message for the invitation"></textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeLocation">
                        <label class="form-check-label">
                            Include user's location in invitation
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeQR">
                        <label class="form-check-label">
                            Include a QR code in the invitation
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="sendBulkInvitations()">Send Invitations</button>
            </div>
        </div>
    </div>
</div>

<!-- User Database Modal -->
<div class="modal fade" id="userDatabaseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-database me-2 text-primary"></i>
                    User Database
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Search Users</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Enter email or name to search">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Activity</th>
                                <th>Last Activity</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userDatabaseTable">
                            <!-- User data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary" onclick="exportUserDatabase()">
                        <i class="fas fa-download me-2"></i>Export Database
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Event filtering
document.getElementById('eventFilter').addEventListener('change', function() {
    const filter = this.value;
    const eventItems = document.querySelectorAll('.event-item');
    
    eventItems.forEach(item => {
        const status = item.dataset.status;
        const active = item.dataset.active;
        
        let show = true;
        
        if (filter === 'active' && active !== 'true') show = false;
        if (filter === 'upcoming' && status !== 'upcoming') show = false;
        if (filter === 'past' && status !== 'past') show = false;
        
        item.style.display = show ? 'block' : 'none';
    });
});

function refreshStats() {
    const refreshBtn = event.target;
    const originalText = showLoading(refreshBtn);
    
    setTimeout(() => {
        hideLoading(refreshBtn, originalText);
        showAlert('Statistics refreshed successfully!', 'success');
    }, 1000);
}

function showAnalytics() {
    const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
    modal.show();
    
    // Initialize charts when modal is shown
    setTimeout(() => {
        initializeCharts();
    }, 100);
}

function showNotifications() {
    const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
    modal.show();
}

function showPartySettings() {
    const modal = new bootstrap.Modal(document.getElementById('partySettingsModal'));
    modal.show();
}

function sendNotification() {
    const form = document.getElementById('notificationForm');
    const formData = new FormData(form);
    
    // Simulate sending notification
    showAlert('Notification sent successfully!', 'success');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('notificationsModal'));
    modal.hide();
}

function savePartySettings() {
    const form = document.getElementById('partySettingsForm');
    const formData = new FormData(form);
    
    // Simulate saving settings
    showAlert('Settings saved successfully!', 'success');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('partySettingsModal'));
    modal.hide();
}

function editEvent(eventId) {
    // Redirect to edit event page
    window.location.href = `/party/edit_event/${eventId}`;
}

function deleteEvent(eventId) {
    if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
        // Simulate deleting event
        showAlert('Event deleted successfully!', 'success');
        
        // Remove event from DOM
        const eventElement = document.querySelector(`[data-event-id="${eventId}"]`);
        if (eventElement) {
            eventElement.remove();
        }
    }
}

function initializeCharts() {
    // Registration trends chart
    const registrationCtx = document.getElementById('registrationChart').getContext('2d');
    new Chart(registrationCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Registrations',
                data: [12, 19, 3, 5, 2, 3],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Attendance rates chart
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(attendanceCtx, {
        type: 'doughnut',
        data: {
            labels: ['Attended', 'Absent', 'Pending'],
            datasets: [{
                data: [65, 20, 15],
                backgroundColor: [
                    'rgb(34, 197, 94)',
                    'rgb(239, 68, 68)',
                    'rgb(245, 158, 11)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Auto-refresh stats every 30 seconds
setInterval(() => {
    // You can implement real-time updates here
}, 30000);

// Bulk Invitation System Functions
function inviteAllUsers() {
    const modal = new bootstrap.Modal(document.getElementById('bulkInvitationModal'));
    modal.show();
    
    // Load user database summary
    loadUserDatabaseSummary();
    loadUserPreview();
}

function loadUserDatabaseSummary() {
    // Get all unique users from all events
    const events = {{ events_data|tojson }};
    const uniqueUsers = new Set();
    const activeUsers = new Set();
    
    events.forEach(event => {
        if (event.registrations) {
            event.registrations.forEach(registration => {
                uniqueUsers.add(registration.user_email);
                if (registration.attended) {
                    activeUsers.add(registration.user_email);
                }
            });
        }
    });
    
    // Update summary
    document.getElementById('totalUsers').textContent = uniqueUsers.size;
    document.getElementById('activeUsers').textContent = uniqueUsers.size;
}

function loadUserPreview() {
    const events = {{ events_data|tojson }};
    const userPreview = [];
    
    events.forEach(event => {
        if (event.registrations) {
            event.registrations.forEach(registration => {
                userPreview.push({
                    email: registration.user_email,
                    lastEvent: event.title,
                    location: registration.latitude && registration.longitude ? 
                        `${registration.latitude.toFixed(2)}, ${registration.longitude.toFixed(2)}` : 'No location',
                    status: registration.attended ? 'Attended' : 'Registered'
                });
            });
        }
    });
    
    // Remove duplicates and show first 10
    const uniqueUsers = userPreview.filter((user, index, self) => 
        index === self.findIndex(u => u.email === user.email)
    ).slice(0, 10);
    
    const tableBody = document.getElementById('userPreviewTable');
    tableBody.innerHTML = uniqueUsers.map(user => `
        <tr>
            <td><small>${user.email}</small></td>
            <td><small>${user.lastEvent}</small></td>
            <td><small>${user.location}</small></td>
            <td>
                <span class="badge bg-${user.status === 'Attended' ? 'success' : 'warning'}">
                    ${user.status}
                </span>
            </td>
        </tr>
    `).join('');
}

function sendBulkInvitations() {
    const targetEventId = document.getElementById('targetEvent').value;
    const customMessage = document.getElementById('customMessage').value;
    const includeLocation = document.getElementById('includeLocation').checked;
    const includeQR = document.getElementById('includeQR').checked;
    
    if (!targetEventId) {
        alert('Please select a target event');
        return;
    }
    
    // Get all unique users
    const events = {{ events_data|tojson }};
    const uniqueUsers = new Set();
    
    events.forEach(event => {
        if (event.registrations) {
            event.registrations.forEach(registration => {
                uniqueUsers.add(registration.user_email);
            });
        }
    });
    
    const userCount = uniqueUsers.size;
    
    if (confirm(`Send invitations to ${userCount} users for the selected event?`)) {
        // Show progress
        const sendButton = document.querySelector('#bulkInvitationModal .btn-success');
        const originalText = sendButton.innerHTML;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        sendButton.disabled = true;
        
        // Simulate sending invitations (replace with actual API call)
        setTimeout(() => {
            sendButton.innerHTML = '<i class="fas fa-check me-2"></i>Sent!';
            sendButton.classList.remove('btn-success');
            sendButton.classList.add('btn-success');
            
            // Show success message
            showAlert(`Successfully sent invitations to ${userCount} users!`, 'success');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                sendButton.innerHTML = originalText;
                sendButton.disabled = false;
                sendButton.classList.remove('btn-success');
                sendButton.classList.add('btn-success');
            }, 2000);
        }, 2000);
    }
}

function showUserDatabase() {
    const modal = new bootstrap.Modal(document.getElementById('userDatabaseModal'));
    modal.show();
    
    // Load user database
    loadUserDatabase();
}

function loadUserDatabase() {
    const events = {{ events_data|tojson }};
    const userDatabase = {};
    
    events.forEach(event => {
        if (event.registrations) {
            event.registrations.forEach(registration => {
                const email = registration.user_email;
                if (!userDatabase[email]) {
                    userDatabase[email] = {
                        email: email,
                        phone: registration.user_phone || 'N/A',
                        eventsAttended: 0,
                        totalEvents: 0,
                        lastActivity: registration.registered_at,
                        location: registration.latitude && registration.longitude ? 
                            `${registration.latitude.toFixed(2)}, ${registration.longitude.toFixed(2)}` : 'No location'
                    };
                }
                
                userDatabase[email].totalEvents++;
                if (registration.attended) {
                    userDatabase[email].eventsAttended++;
                }
                
                // Update last activity
                if (new Date(registration.registered_at) > new Date(userDatabase[email].lastActivity)) {
                    userDatabase[email].lastActivity = registration.registered_at;
                }
            });
        }
    });
    
    // Convert to array and sort by last activity
    const userArray = Object.values(userDatabase).sort((a, b) => 
        new Date(b.lastActivity) - new Date(a.lastActivity)
    );
    
    // Populate table
    const tableBody = document.getElementById('userDatabaseTable');
    tableBody.innerHTML = userArray.map(user => `
        <tr>
            <td><strong>${user.email}</strong></td>
            <td>${user.phone}</td>
            <td>
                <span class="badge bg-success me-1">${user.eventsAttended}</span>
                <span class="badge bg-secondary">${user.totalEvents}</span>
            </td>
            <td><small>${new Date(user.lastActivity).toLocaleDateString()}</small></td>
            <td><small>${user.location}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetails('${user.email}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="inviteUser('${user.email}')">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const tableRows = document.querySelectorAll('#userDatabaseTable tr');
    
    tableRows.forEach(row => {
        const email = row.cells[0].textContent.toLowerCase();
        if (email.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function exportUserDatabase() {
    // Implement CSV export functionality
    alert('User database export functionality coming soon!');
}

function viewUserDetails(email) {
    // Implement individual user details view
    alert(`Viewing details for: ${email}`);
}

function inviteUser(email) {
    // Implement individual user invitation
    alert(`Sending invitation to: ${email}`);
}

// Utility functions
function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of content
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.stats-card {
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.stats-icon {
    opacity: 0.8;
}

.event-card {
    transition: all 0.3s ease;
}

.event-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
}

.stat-item {
    padding: 0.5rem;
    border-radius: 8px;
    background: rgba(30, 64, 175, 0.05);
}

.event-meta small {
    font-size: 0.8rem;
}

.empty-state {
    color: #6c757d;
}

.quick-actions .btn {
    transition: all 0.3s ease;
}

.quick-actions .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.dropdown-menu {
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.dropdown-item {
    border-radius: 8px;
    margin: 2px 8px;
    padding: 8px 12px;
}

.dropdown-item:hover {
    background-color: rgba(30, 64, 175, 0.1);
}
</style>
{% endblock %}

